<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Galactic Archives - Worldbuilding Wiki</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    body { background-color: #000; color: #e2e8f0; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #02040a; }
    ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #334155; }

    .text-glow { text-shadow: 0 0 30px rgba(59, 130, 246, 0.3); }
    .btn-glow { box-shadow: 0 0 20px -5px rgba(59, 130, 246, 0.5); }

    .fade-enter { opacity: 0; transform: translateY(10px); animation: fadein 0.3s forwards ease-out; }
    @keyframes fadein { to { opacity: 1; transform: translateY(0); } }

    /* Note: custom Tailwind classes like bg-space-950, bg-star-gradient require your Tailwind config.
       This file preserves them so your theme remains if you have that config. */
  </style>
</head>

<body class="font-sans min-h-screen bg-space-950 bg-star-gradient bg-no-repeat bg-fixed selection:bg-blue-500/30 selection:text-blue-100 flex flex-col overflow-hidden">
  <!-- Navbar -->
  <nav class="sticky top-0 z-50 w-full border-b border-white/5 bg-space-950/80 backdrop-blur-md">
    <div class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
      <div class="flex items-center gap-8">
        <!-- Logo -->
        <a href="#" onclick="renderHome()" class="flex items-center gap-2 group">
          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-cyan-400 opacity-80 group-hover:opacity-100 transition-opacity blur-[1px]"></div>
          <span class="text-2xl tracking-tight font-normal text-white group-hover:text-glow transition-all">Galactic</span>
        </a>

        <!-- Desktop Nav -->
        <div class="hidden md:flex items-center gap-6 text-sm font-light text-gray-400">
          <button onclick="renderDashboard()" class="hover:text-white transition-colors">Dashboard</button>
          <button onclick="renderCategory('Lore')" class="hover:text-white transition-colors">Lore</button>
          <button onclick="renderCategory('Characters')" class="hover:text-white transition-colors">Characters</button>
          <button onclick="renderCategory('Locations')" class="hover:text-white transition-colors">Locations</button>
        </div>
      </div>

      <div class="flex items-center gap-4">
        <!-- Search -->
        <div class="relative hidden sm:block group search-group">
          <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500 group-focus-within:text-blue-400 transition-colors"></i>
          <input type="text" id="globalSearch" placeholder="Search archives..." oninput="handleSearch(this.value)"
                 class="bg-white/5 border border-white/10 rounded-full py-2 pl-10 pr-4 text-sm text-gray-200 w-64 focus:outline-none" />
          <!-- Dropdown for search results -->
          <div id="searchResults" class="absolute top-full mt-2 left-0 w-full bg-space-900 border border-white/10 rounded-xl shadow-2xl overflow-hidden hidden"></div>
        </div>

        <!-- New Entry Button -->
        <button onclick="openEditor()" class="flex items-center gap-2 bg-white/10 hover:bg-white/20 border border-white/10 hover:border-blue-400/30 text-white px-5 py-2 rounded-full text-sm font-light">
          <span>New Entry</span>
          <i data-lucide="plus" class="w-4 h-4"></i>
        </button>

        <!-- Google Drive Connect Button -->
        <div class="flex items-center gap-2">
          <button id="driveConnectBtn" onclick="toggleDriveConnection()" class="flex items-center gap-2 bg-white/10 hover:bg-white/20 border border-white/10 text-white px-4 py-2 rounded-full text-sm">
            <i data-lucide="cloud" class="w-4 h-4"></i>
            <span id="driveStatusText">Connect Drive</span>
          </button>

          <!-- Folder selector -->
          <button id="driveFolderBtn" onclick="openDriveFolderSelector()" class="flex items-center gap-2 bg-white/5 text-white px-3 py-2 rounded-full text-sm border border-white/10 hover:bg-white/10">
            <i data-lucide="folder" class="w-4 h-4"></i>
            <span id="driveFolderText">Choose Folder</span>
          </button>
        </div>

        <!-- Settings (compact gear, opens modal) -->
        <button id="settingsBtn" onclick="openSettings()" class="text-gray-400 hover:text-white px-2 py-1 rounded" title="Settings">
          <i data-lucide="settings" class="w-5 h-5"></i>
        </button>

        <button class="md:hidden text-gray-400 hover:text-white">
          <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
      </div>
    </div>
  </nav>

  <!-- Main Layout -->
  <div class="flex flex-1 overflow-hidden min-h-0">
    <!-- Sidebar (Optional for larger screens, hidden on mobile for now) -->
    <aside class="w-64 border-r border-white/5 bg-space-950/50 hidden lg:flex flex-col py-8 px-4 gap-6 overflow-y-auto">
      <div class="px-2">
        <h3 class="text-xs uppercase tracking-widest text-gray-500 mb-4 font-medium">Library</h3>
        <nav class="flex flex-col gap-1">
          <button onclick="renderDashboard()" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 text-gray-400 hover:text-white text-left text-sm transition-colors">
            <i data-lucide="layout-grid" class="w-4 h-4"></i> Overview
          </button>
          <button onclick="renderCategory('Lore')" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 text-gray-400 hover:text-white text-left text-sm transition-colors">
            <i data-lucide="book-open" class="w-4 h-4"></i> Lore
          </button>
          <button onclick="renderCategory('Characters')" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 text-gray-400 hover:text-white text-left text-sm transition-colors">
            <i data-lucide="users" class="w-4 h-4"></i> Characters
          </button>
          <button onclick="renderCategory('Locations')" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 text-gray-400 hover:text-white text-left text-sm transition-colors">
            <i data-lucide="map" class="w-4 h-4"></i> Locations
          </button>
          <button onclick="renderCategory('Factions')" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 text-gray-400 hover:text-white text-left text-sm transition-colors">
            <i data-lucide="flag" class="w-4 h-4"></i> Factions
          </button>
          <button onclick="renderCategory('Magic')" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 text-gray-400 hover:text-white text-left text-sm transition-colors">
            <i data-lucide="sparkles" class="w-4 h-4"></i> Magic Systems
          </button>
          <button onclick="renderCategory('Events')" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 text-gray-400 hover:text-white text-left text-sm transition-colors">
            <i data-lucide="hourglass" class="w-4 h-4"></i> Events
          </button>
        </nav>
      </div>

      <div class="px-2 mt-auto">
        <h3 class="text-xs uppercase tracking-widest text-gray-500 mb-4 font-medium">System</h3>
        <div class="bg-gradient-to-br from-blue-900/20 to-purple-900/20 border border-white/5 rounded-xl p-4">
          <p class="text-xs text-blue-200 mb-2">Wiki Status: <span class="text-green-400">Online</span></p>
          <div class="w-full bg-space-900 h-1.5 rounded-full overflow-hidden">
            <div class="bg-blue-500 h-full w-3/4 rounded-full shadow-[0_0_10px_rgba(59,130,246,0.8)]"></div>
          </div>
          <p class="text-[10px] text-gray-500 mt-2 text-right">v2.4.0 Galactic</p>
        </div>
      </div>
    </aside>

    <!-- Dynamic Content Area -->
    <main id="appContent" class="flex-1 overflow-y-auto relative p-6 md:p-12 scroll-smooth min-h-0">
      <!-- Content injected via JS -->
    </main>
  </div>

  <!-- Scroll top button -->
  <button id="scrollTopBtn" onclick="document.getElementById('appContent').scrollTo({ top: 0, behavior: 'smooth' })"
          class="fixed bottom-8 right-8 z-50 p-4 bg-blue-600 text-white rounded-full btn-glow opacity-0 pointer-events-none transform translate-y-10 transition-all">
    <i data-lucide="arrow-up" class="w-6 h-6 group-hover:-translate-y-1 transition-transform"></i>
  </button>

  <script>
    // scroll-top visibility logic (listens to both container and window)
    (function() {
      const content = document.getElementById('appContent');
      const btn = document.getElementById('scrollTopBtn');
      if (!btn) return;

      function updateScrollBtn() {
        const sc = (content && typeof content.scrollTop === 'number') ? content.scrollTop : (window.scrollY || document.documentElement.scrollTop);
        const show = sc > 300;
        btn.classList.toggle('opacity-0', !show);
        btn.classList.toggle('translate-y-10', !show);
        btn.classList.toggle('pointer-events-none', !show);
      }

      if (content) content.addEventListener('scroll', updateScrollBtn);
      window.addEventListener('scroll', updateScrollBtn);
      setTimeout(updateScrollBtn, 50);
    })();
  </script>

  <script>
    // --- Mock Database ---
    const initialData = [
      {
        id: '1',
        title: 'The Great Expansion',
        category: 'Events',
        tags: ['History', 'Space Travel'],
        content: "The Great Expansion marked the beginning of humanity's journey beyond the Sol system. Fueled by the discovery of the Void Drive, colony ships were dispatched to nearby systems and beyond.",
        lastUpdated: '2045-10-12'
      },
      {
        id: '2',
        title: 'Commander Vex',
        category: 'Characters',
        tags: ['Hero', 'Military', 'Human'],
        content: "Commander Vex is a legendary figure in the Terran Fleet. Known for his tactical brilliance during the Siege of Orion, he coordinated the defense of several colonies.",
        lastUpdated: '2045-11-05'
      },
      {
        id: '3',
        title: 'Void Drive',
        category: 'Magic',
        tags: ['Technology', 'Physics'],
        content: "The Void Drive manipulates dark matter to fold local space-time, allowing for faster-than-light travel without time dilation effects usually associated with relativistic speeds.",
        lastUpdated: '2045-09-20'
      },
      {
        id: '4',
        title: 'Sector 7',
        category: 'Locations',
        tags: ['Industrial', 'Dangerous'],
        content: 'A lawless region on the outer rim. Known for its black markets and ship chop shops. The Galactic Federation has no official presence here.',
        lastUpdated: '2045-12-01'
      }
    ];

    // --- State Management ---
    let entries = JSON.parse(localStorage.getItem('wikiEntries')) || initialData.slice();

    // Google Drive Configuration
    const GOOGLE_CLIENT_ID = '1073328285370-leiiu235gcp0ujm9s7pagi6p9quui977.apps.googleusercontent.com';
    const DRIVE_FILE_NAME = 'galactic-archives-wiki.json';
    // permit file creation + metadata listing so we can list folders
    const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.metadata.readonly';

    let gapiLoaded = false;
    let gisLoaded = false;
    let gapiInited = false;
    let tokenClient = null;
    let driveFileId = localStorage.getItem('driveFileId') || null;
    let isDriveConnected = localStorage.getItem('isDriveConnected') === 'true';
    let driveFolderId = localStorage.getItem('driveFolderId') || null;
    let driveFolderName = localStorage.getItem('driveFolderName') || null;

    // Settings / import-export option
    let autoSaveToDrive = localStorage.getItem('autoSaveToDrive') === 'true';

    // Initialize Google APIs
    function gapiLoadedCallback() {
      console.log('GAPI loaded');
      gapiLoaded = true;
      if (window.gapi && gapi.load) gapi.load('client', initializeGapiClient);
    }

    function gisLoadedCallback() {
      console.log('GIS loaded');
      gisLoaded = true;
      maybeEnableButtons();
    }

    async function initializeGapiClient() {
      try {
        await gapi.client.init({
          discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
        });
        gapiInited = true;
        console.log('GAPI client initialized');
        maybeEnableButtons();
      } catch (error) {
        console.error('Error initializing GAPI client:', error);
      }
    }

    function maybeEnableButtons() {
      if (gapiLoaded && gisLoaded && gapiInited) {
        console.log('All APIs loaded and initialized');
        if (GOOGLE_CLIENT_ID !== 'YOUR_GOOGLE_CLIENT_ID_HERE') {
          tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: SCOPES,
            callback: '', // will set when requesting
          });
          updateDriveButton();
        } else {
          const btn = document.getElementById('driveConnectBtn');
          if (btn) btn.style.display = 'none';
        }
      }
    }

    // Load Google API scripts
    window.gapiLoaded = gapiLoadedCallback;
    window.gisLoaded = gisLoadedCallback;
    (function() {
      const gapiScript = document.createElement('script');
      gapiScript.src = 'https://apis.google.com/js/api.js';
      gapiScript.async = true;
      gapiScript.defer = true;
      gapiScript.onload = gapiLoadedCallback;
      gapiScript.onerror = () => console.error('Failed to load Google API');
      document.head.appendChild(gapiScript);

      const gisScript = document.createElement('script');
      gisScript.src = 'https://accounts.google.com/gsi/client';
      gisScript.async = true;
      gisScript.defer = true;
      gisScript.onload = gisLoadedCallback;
      gisScript.onerror = () => console.error('Failed to load Google Identity Services');
      document.head.appendChild(gisScript);
    })();

    // Save to local and optionally Drive
    const saveToLocal = () => {
      localStorage.setItem('wikiEntries', JSON.stringify(entries));
      if (autoSaveToDrive && isDriveConnected && gapiInited) {
        saveToDrive();
      }
    };

    // Google Drive Functions
    async function saveToDrive() {
      if (!gapi.client || !gapi.client.getToken() || !gapi.client.getToken().access_token) {
        console.log('Not authenticated with Google Drive');
        return;
      }

      try {
        const fileContent = JSON.stringify(entries, null, 2);
        const metadata = {
          name: DRIVE_FILE_NAME,
          mimeType: 'application/json',
          ...(driveFolderId ? { parents: [driveFolderId] } : {})
        };

        const boundary = '-------314159265358979323846';
        const delimiter = '\r\n--' + boundary + '\r\n';
        const closeDelim = '\r\n--' + boundary + '--';
        const multipartRequestBody =
          delimiter +
          'Content-Type: application/json\r\n\r\n' +
          JSON.stringify(metadata) +
          delimiter +
          'Content-Type: application/json\r\n\r\n' +
          fileContent +
          closeDelim;

        if (driveFileId) {
          const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=multipart`, {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${gapi.client.getToken().access_token}`,
              'Content-Type': `multipart/related; boundary="${boundary}"`
            },
            body: multipartRequestBody
          });

          if (response.ok) {
            console.log('Successfully saved to Google Drive (update)');
            showNotification('Saved to Google Drive', 'success');
          } else {
            const errorText = await response.text();
            console.error('Drive save error:', errorText);
            throw new Error('Failed to update file');
          }
        } else {
          const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${gapi.client.getToken().access_token}`,
              'Content-Type': `multipart/related; boundary="${boundary}"`
            },
            body: multipartRequestBody
          });

          if (response.ok) {
            const data = await response.json();
            driveFileId = data.id;
            localStorage.setItem('driveFileId', driveFileId);
            console.log('Successfully created file in Google Drive');
            showNotification('Saved to Google Drive', 'success');
          } else {
            const errorText = await response.text();
            console.error('Drive create error:', errorText);
            throw new Error('Failed to create file');
          }
        }
      } catch (error) {
        console.error('Error saving to Google Drive:', error);
        showNotification('Failed to save to Google Drive', 'error');
      }
    }

    async function loadFromDrive() {
      if (!gapi.client || !gapi.client.getToken() || !gapi.client.getToken().access_token) {
        console.log('Not authenticated with Google Drive');
        return;
      }

      try {
        if (!driveFileId) {
          const response = await gapi.client.drive.files.list({
            q: `name='${DRIVE_FILE_NAME}' and trashed=false`,
            fields: 'files(id, name)',
            spaces: 'drive'
          });

          if (response.result.files && response.result.files.length > 0) {
            driveFileId = response.result.files[0].id;
            localStorage.setItem('driveFileId', driveFileId);
          } else {
            console.log('File not found in Google Drive');
            return;
          }
        }

        const resp = await fetch(`https://www.googleapis.com/drive/v3/files/${driveFileId}?alt=media`, {
          headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` }
        });

        if (resp.ok) {
          const text = await resp.text();
          const data = JSON.parse(text);
          if (Array.isArray(data)) {
            entries = data;
            localStorage.setItem('wikiEntries', JSON.stringify(entries));
            showNotification('Loaded from Google Drive', 'success');
            if (typeof renderDashboard === 'function') renderDashboard();
          } else {
            showNotification('Drive file is not the expected format', 'error');
          }
        } else {
          const errorText = await resp.text();
          console.error('Drive load error:', errorText);
          throw new Error('Failed to load file');
        }
      } catch (error) {
        console.error('Error loading from Google Drive:', error);
        showNotification('Failed to load from Google Drive', 'error');
      }
    }

    function toggleDriveConnection() {
      if (!gapiInited || !gisLoaded) {
        showNotification('Google APIs still loading. Please wait a moment and try again.', 'info');
        return;
      }

      if (isDriveConnected) {
        // Disconnect
        if (gapi.client) {
          const token = gapi.client.getToken();
          if (token && token.access_token) {
            google.accounts.oauth2.revoke(token.access_token, () => {
              console.log('Token revoked');
            });
            gapi.client.setToken('');
          }
        }
        isDriveConnected = false;
        localStorage.setItem('isDriveConnected', 'false');
        driveFileId = null;
        localStorage.removeItem('driveFileId');
        updateDriveButton();
        showNotification('Disconnected from Google Drive', 'info');
      } else {
        // Connect
        if (!tokenClient) {
          showNotification('Google API not configured. Please set GOOGLE_CLIENT_ID.', 'error');
          return;
        }

        tokenClient.callback = async (resp) => {
          if (resp.error !== undefined) {
            console.error('Auth error:', resp);
            showNotification('Failed to connect to Google Drive: ' + resp.error, 'error');
            return;
          }

          console.log('Successfully authenticated with Google Drive');
          isDriveConnected = true;
          localStorage.setItem('isDriveConnected', 'true');
          updateDriveButton();
          showNotification('Connected to Google Drive', 'success');

          // Try to load existing file or create new one
          try {
            await loadFromDrive();
          } catch (error) {
            console.log('No existing file found, will create on next save');
            await saveToDrive();
          }
        };

        if (!gapi.client.getToken()) {
          tokenClient.requestAccessToken({ prompt: 'consent' });
        } else {
          tokenClient.requestAccessToken({ prompt: '' });
        }
      }
    }

    function updateDriveButton() {
      const btn = document.getElementById('driveConnectBtn');
      const statusText = document.getElementById('driveStatusText');
      const folderText = document.getElementById('driveFolderText');

      if (btn && statusText) {
        if (isDriveConnected) {
          btn.classList.remove('hover:border-green-400/30');
          btn.classList.add('hover:border-red-400/30', 'border-green-500/50');
          statusText.textContent = 'Disconnect Drive';
          btn.querySelector('i').setAttribute('data-lucide', 'cloud-check');
        } else {
          btn.classList.remove('hover:border-red-400/30', 'border-green-500/50');
          btn.classList.add('hover:border-green-400/30');
          statusText.textContent = 'Connect Drive';
          btn.querySelector('i').setAttribute('data-lucide', 'cloud');
        }
        if (folderText) {
          folderText.textContent = driveFolderName ? (driveFolderName.length > 20 ? driveFolderName.slice(0,20) + 'â€¦' : driveFolderName) : 'Choose Folder';
        }
        lucide.createIcons();
      }
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      const colors = {
        success: 'bg-green-500/20 border-green-500/50 text-green-400',
        error: 'bg-red-500/20 border-red-500/50 text-red-400',
        info: 'bg-blue-500/20 border-blue-500/50 text-blue-400'
      };

      notification.className = `fixed top-24 right-6 z-50 px-4 py-3 rounded-lg border ${colors[type]} backdrop-blur-md fade-enter`;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(20px)';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    const categories = ['Lore', 'Characters', 'Locations', 'Timelines', 'Factions', 'Magic', 'Events'];

    // --- Render Functions ---
    function renderHome() {
      const container = document.getElementById('appContent');
      container.innerHTML = `
        <div class="flex flex-col items-center justify-center min-h-[80vh] text-center max-w-4xl mx-auto fade-enter relative z-10">
          <div class="absolute inset-0 bg-blue-500/10 blur-[120px] rounded-full -z-10 pointer-events-none"></div>
          <span class="text-blue-400 text-sm tracking-[0.3em] uppercase mb-6 border border-blue-500/20 px-4 py-1.5 rounded-full bg-blue-500/5">System Initialized</span>
          <h1 class="text-6xl md:text-8xl font-normal text-white tracking-tighter mb-8 leading-[0.9] text-glow">
            EXPLORE <br/> <span class="text-transparent bg-clip-text bg-gradient-to-b from-white to-white/40">THE ARCHIVES</span>
          </h1>
          <p class="text-xl md:text-2xl text-gray-400 font-light max-w-2xl mb-12 leading-relaxed">
            The central repository for all knowledge regarding the universe, its inhabitants, and the forces that shape our destiny.
          </p>

          <div class="flex gap-6">
            <button onclick="renderDashboard()" class="group relative px-8 py-4 bg-blue-600 text-white rounded-full overflow-hidden transition-all hover:bg-blue-500 btn-glow flex items-center">
              <span class="relative z-10 text-base font-normal">Enter Database</span>
              <i data-lucide="arrow-right" class="w-5 h-5 relative z-10 ml-3 group-hover:translate-x-1 transition-transform"></i>
              <div class="absolute inset-0 bg-gradient-to-r from-blue-400 to-cyan-300 opacity-0 group-hover:opacity-20 transition-opacity"></div>
            </button>

            <button onclick="openEditor()" class="px-8 py-4 bg-white/5 border border-white/10 text-white rounded-full hover:bg-white/10 transition-all flex items-center gap-3">
              <span class="text-base font-normal">Create Entry</span>
            </button>
          </div>

          <div class="mt-24 w-full relative">
            <div class="w-full h-[1px] bg-gradient-to-r from-transparent via-blue-500/50 to-transparent"></div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-8 mt-8 text-left">
              ${[
                { label: 'Total Entries', value: entries.length },
                { label: 'Categories', value: categories.length },
                { label: 'Last Update', value: 'Today' },
                { label: 'System Status', value: 'Optimal' }
              ].map(stat => `
                <div>
                  <p class="text-4xl text-white font-light tracking-tight mb-1">${stat.value}</p>
                  <p class="text-xs text-blue-400/80 uppercase tracking-widest">${stat.label}</p>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
      lucide.createIcons();
    }

    function renderDashboard() {
      const container = document.getElementById('appContent');
      const recentEntries = [...entries].sort((a,b) => new Date(b.lastUpdated) - new Date(a.lastUpdated)).slice(0, 6);

      container.innerHTML = `
        <div class="max-w-6xl mx-auto fade-enter">
          <header class="mb-12 border-b border-white/5 pb-8">
            <h2 class="text-4xl text-white tracking-tight font-normal mb-4">Dashboard</h2>
            <p class="text-lg text-gray-400 font-light">Welcome back, Architect. Here is the current state of the world.</p>
          </header>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-16">
            <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
              ${categories.slice(0, 4).map(cat => {
                const count = entries.filter(e => e.category === cat).length;
                return `
                  <div onclick="renderCategory('${cat}')" class="group cursor-pointer bg-white/[0.02] border border-white/5 hover:border-blue-500/30 p-6 rounded-2xl transition-all relative">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                      <i data-lucide="folder" class="w-16 h-16 text-blue-500"></i>
                    </div>
                    <h3 class="text-xl text-white font-normal mb-1">${cat}</h3>
                    <p class="text-sm text-gray-500">${count} entries</p>
                  </div>
                `;
              }).join('')}
            </div>

            <div class="bg-gradient-to-b from-blue-900/10 to-transparent border border-white/5 rounded-2xl p-6 flex flex-col justify-center items-center text-center">
              <div class="w-16 h-16 rounded-full bg-blue-500/20 flex items-center justify-center mb-4 text-blue-400 shadow-[0_0_20px_rgba(59,130,246,0.3)]">
                <i data-lucide="plus" class="w-8 h-8"></i>
              </div>
              <h3 class="text-xl text-white font-normal mb-2">Expand the World</h3>
              <p class="text-sm text-gray-400 mb-6 font-light">Add a new character, location, or event to the database.</p>
              <button onclick="openEditor()" class="w-full py-3 bg-white text-black rounded-lg hover:bg-gray-200 transition-colors font-medium text-sm">Create New Entry</button>
            </div>
          </div>

          <h3 class="text-xl text-white tracking-tight font-normal mb-6 flex items-center gap-2">
            <i data-lucide="clock" class="w-5 h-5 text-blue-500"></i> Recently Updated
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            ${recentEntries.map(entry => entryCard(entry)).join('')}
          </div>
        </div>
      `;
      lucide.createIcons();
    }

    function renderCategory(category) {
      const container = document.getElementById('appContent');
      const categoryEntries = entries.filter(e => e.category === category);

      container.innerHTML = `
        <div class="max-w-6xl mx-auto fade-enter">
          <div class="flex items-center gap-2 text-sm text-gray-500 mb-6">
            <span class="cursor-pointer hover:text-white" onclick="renderDashboard()">Dashboard</span>
            <i data-lucide="chevron-right" class="w-3 h-3"></i>
            <span class="text-blue-400">${category}</span>
          </div>

          <header class="mb-10 flex justify-between items-end border-b border-white/5 pb-8">
            <div>
              <h2 class="text-4xl text-white tracking-tight font-normal mb-2">${category}</h2>
              <p class="text-lg text-gray-400 font-light">Browsing all entries within ${category}.</p>
            </div>
            <button onclick="openEditor('${category}')" class="flex items-center gap-2 px-4 py-2 bg-blue-600/10 text-blue-400 border border-blue-500/20 rounded-lg hover:bg-blue-600/20 transition-colors">
              <i data-lucide="plus" class="w-4 h-4"></i> Add ${category}
            </button>
          </header>

          ${categoryEntries.length > 0 ? `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              ${categoryEntries.map(entry => entryCard(entry)).join('')}
            </div>
          ` : `
            <div class="text-center py-20 border border-dashed border-white/10 rounded-2xl bg-white/[0.01]">
              <p class="text-gray-500 mb-4">No entries found in this category.</p>
              <button onclick="openEditor('${category}')" class="text-blue-400 hover:text-blue-300 underline underline-offset-4 decoration-blue-500/30">Create the first one</button>
            </div>
          `}
        </div>
      `;
      lucide.createIcons();
    }

    function renderEntry(id) {
      const entry = entries.find(e => e.id === id);
      if (!entry) return;
      const container = document.getElementById('appContent');

      const formattedContent = (entry.content || '').split('\n').map(p => p.trim() ? `<p class="mb-6 leading-8">${escapeHtml(p)}</p>` : '').join('');

      container.innerHTML = `
        <div class="max-w-3xl mx-auto fade-enter pt-4">
          <div class="flex items-center gap-2 text-sm text-gray-500 mb-8 font-light">
            <span class="cursor-pointer hover:text-white" onclick="renderDashboard()">Dashboard</span>
            <i data-lucide="chevron-right" class="w-3 h-3"></i>
            <span class="cursor-pointer hover:text-white" onclick="renderCategory('${entry.category}')">${entry.category}</span>
            <i data-lucide="chevron-right" class="w-3 h-3"></i>
            <span class="text-white truncate max-w-[200px]">${escapeHtml(entry.title)}</span>
          </div>

          <div class="mb-10">
            <div class="flex items-center gap-3 mb-4">
              <span class="px-2 py-1 rounded text-xs font-medium uppercase tracking-wider bg-blue-500/10 text-blue-400 border border-blue-500/20">${entry.category}</span>
              ${entry.tags.map(tag => `<span class="text-xs text-gray-500">#${escapeHtml(tag)}</span>`).join('')}
            </div>
            <h1 class="text-5xl md:text-6xl text-white tracking-tighter font-normal mb-8 leading-[1.1]">${escapeHtml(entry.title)}</h1>

            <div class="flex items-center gap-4 border-y border-white/5 py-4 text-sm text-gray-500">
              <div class="flex items-center gap-2">
                <i data-lucide="calendar" class="w-4 h-4"></i>
                <span>Updated ${entry.lastUpdated}</span>
              </div>
              <div class="flex-1"></div>
              <button onclick="openEditor(null, '${entry.id}')" class="flex items-center gap-2 hover:text-white transition-colors">
                <i data-lucide="edit-3" class="w-4 h-4"></i> Edit
              </button>
              <button onclick="deleteEntry('${entry.id}')" class="flex items-center gap-2 hover:text-red-400 transition-colors">
                <i data-lucide="trash-2" class="w-4 h-4"></i> Delete
              </button>
            </div>
          </div>

          <article class="prose prose-invert prose-lg max-w-none text-gray-300 font-light">
            ${formattedContent}
          </article>

          <div class="mt-20 pt-10 border-t border-white/5">
            <h4 class="text-sm font-medium text-gray-500 uppercase tracking-widest mb-6">Related Entries</h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              ${entries.filter(e => e.id !== id && e.category === entry.category).slice(0,2).map(e => `
                <div onclick="renderEntry('${e.id}')" class="cursor-pointer p-4 rounded-lg bg-white/5 hover:bg-white/10 transition-colors border border-white/5">
                  <h5 class="text-white font-medium mb-1">${escapeHtml(e.title)}</h5>
                  <p class="text-xs text-gray-500 line-clamp-1">${escapeHtml(e.content).slice(0,120)}</p>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
      lucide.createIcons();
    }

    function openEditor(prefillCategory = null, editId = null) {
      const container = document.getElementById('appContent');

      let data = { title: '', category: prefillCategory || 'Lore', tags: '', content: '' };
      if (editId) {
        const existing = entries.find(e => e.id === editId);
        if (existing) data = { ...existing, tags: (existing.tags || []).join(', ') };
      }

      container.innerHTML = `
        <div class="max-w-4xl mx-auto fade-enter">
          <div class="flex items-center justify-between mb-8">
            <h2 class="text-3xl text-white tracking-tight font-normal">${editId ? 'Edit Entry' : 'Create New Entry'}</h2>
            <button onclick="${editId ? `renderEntry('${editId}')` : 'renderDashboard()'}" class="text-gray-400 hover:text-white text-sm">Cancel</button>
          </div>

          <form id="entryForm" onsubmit="handleSave(event, '${editId || ''}')" class="space-y-8">
            <div class="group">
              <label class="block text-xs font-medium uppercase tracking-widest text-gray-500 mb-2">Title</label>
              <input type="text" name="title" value="${escapeHtml(data.title)}" required placeholder="e.g. The Void Gate"
                     class="w-full bg-transparent text-4xl md:text-5xl font-light text-white placeholder-gray-700 border-b border-white/10 pb-4 focus:outline-none focus:border-blue-500 transition-colors" />
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div>
                <label class="block text-xs font-medium uppercase tracking-widest text-gray-500 mb-2">Category</label>
                <div class="relative">
                  <select name="category" class="w-full appearance-none bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500">
                    ${categories.map(c => `<option value="${c}" ${c === data.category ? 'selected' : ''}>${c}</option>`).join('')}
                  </select>
                  <i data-lucide="chevron-down" class="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500 pointer-events-none"></i>
                </div>
              </div>

              <div>
                <label class="block text-xs font-medium uppercase tracking-widest text-gray-500 mb-2">Tags (comma separated)</label>
                <input type="text" name="tags" value="${escapeHtml(data.tags)}" placeholder="e.g. History, War, Magic"
                       class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 focus:bg-white/10 transition-colors" />
              </div>
            </div>

            <div>
              <label class="block text-xs font-medium uppercase tracking-widest text-gray-500 mb-2">Content</label>
              <textarea name="content" required rows="12" placeholder="Start writing..."
                        class="w-full bg-white/5 border border-white/10 rounded-xl p-6 text-lg text-gray-300 font-light leading-relaxed focus:outline-none focus:border-blue-500 focus:bg-white/10 transition-colors">${escapeHtml(data.content)}</textarea>
            </div>

            <div class="flex justify-end gap-4 pt-4 border-t border-white/5">
              <button type="button" onclick="${editId ? `renderEntry('${editId}')` : 'renderDashboard()'}" class="px-6 py-3 rounded-full text-gray-400 hover:text-white transition-colors">Discard</button>
              <button type="submit" class="px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-full font-medium shadow-[0_0_20px_-5px_rgba(59,130,246,0.6)] transition-all transform">${editId ? 'Save Changes' : 'Publish Entry'}</button>
            </div>
          </form>
        </div>
      `;
      lucide.createIcons();
    }

    // --- Helper Components & Logic ---
    function entryCard(entry) {
      return `
        <div onclick="renderEntry('${entry.id}')" class="group cursor-pointer flex flex-col justify-between h-full bg-white/[0.02] border border-white/5 hover:border-blue-500/40 rounded-xl p-6">
          <div>
            <div class="flex justify-between items-start mb-4">
              <span class="text-xs font-medium text-blue-400 bg-blue-900/20 px-2 py-0.5 rounded border border-blue-500/20">${escapeHtml(entry.category)}</span>
              <i data-lucide="arrow-up-right" class="w-4 h-4 text-gray-600 group-hover:text-blue-400 transition-colors"></i>
            </div>
            <h4 class="text-xl text-white font-normal mb-2 tracking-tight group-hover:text-blue-100 transition-colors">${escapeHtml(entry.title)}</h4>
            <p class="text-sm text-gray-500 line-clamp-3 font-light leading-relaxed">${escapeHtml(entry.content).slice(0, 180)}</p>
          </div>
          <div class="mt-6 flex flex-wrap gap-2">
            ${(entry.tags || []).slice(0, 3).map(t => `<span class="text-[10px] uppercase tracking-wider text-gray-600">#${escapeHtml(t)}</span>`).join('')}
          </div>
        </div>
      `;
    }

    function handleSave(event, id) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const entryData = {
        title: formData.get('title'),
        category: formData.get('category'),
        tags: (formData.get('tags') || '').split(',').map(t => t.trim()).filter(t => t),
        content: formData.get('content'),
        lastUpdated: new Date().toISOString().split('T')[0]
      };

      if (id) {
        const index = entries.findIndex(e => e.id === id);
        if (index !== -1) entries[index] = { ...entries[index], ...entryData };
        renderEntry(id);
      } else {
        const newId = Date.now().toString();
        entries.push({ id: newId, ...entryData });
        renderDashboard();
      }
      saveToLocal();
    }

    function deleteEntry(id) {
      if (confirm('Are you sure you want to delete this entry? This cannot be undone.')) {
        entries = entries.filter(e => e.id !== id);
        saveToLocal();
        renderDashboard();
      }
    }

    // Global Search Logic
    function handleSearch(query) {
      const resultsContainer = document.getElementById('searchResults');
      if (!resultsContainer) return;
      if (!query || !query.trim()) {
        resultsContainer.classList.add('hidden');
        return;
      }

      const lowerQuery = query.toLowerCase();
      const results = entries.filter(e =>
        e.title.toLowerCase().includes(lowerQuery) ||
        e.content.toLowerCase().includes(lowerQuery) ||
        (e.tags || []).some(t => t.toLowerCase().includes(lowerQuery))
      );

      resultsContainer.innerHTML = results.length > 0
        ? results.slice(0, 5).map(e => `
            <div onclick="renderEntry('${e.id}'); document.getElementById('searchResults').classList.add('hidden'); document.getElementById('globalSearch').value=''"
                 class="p-3 hover:bg-white/10 cursor-pointer border-b border-white/5 last:border-0 flex items-center justify-between group">
              <div>
                <p class="text-sm text-white group-hover:text-blue-200">${escapeHtml(e.title)}</p>
                <p class="text-xs text-gray-500">${escapeHtml(e.category)}</p>
              </div>
              <i data-lucide="corner-down-left" class="w-3 h-3 text-gray-600"></i>
            </div>
          `).join('')
        : `<div class="p-4 text-xs text-gray-500 text-center">No results found in archives.</div>`;

      resultsContainer.classList.remove('hidden');
      lucide.createIcons();
    }

    // Close search when clicking outside
    document.addEventListener('click', (e) => {
      const searchContainer = document.querySelector('.search-group');
      if (!searchContainer) return;
      if (!searchContainer.contains(e.target)) {
        const sr = document.getElementById('searchResults');
        if (sr) sr.classList.add('hidden');
      }
    });

    // --- Drive folder picker helpers ---
    async function listDriveFolders() {
      if (!gapiInited || !gapi.client) return [];
      const token = gapi.client.getToken();
      if (!token || !token.access_token) {
        console.warn('No auth token - please connect to Drive first');
        return [];
      }
      try {
        const res = await gapi.client.drive.files.list({
          q: "mimeType='application/vnd.google-apps.folder' and trashed = false",
          fields: 'nextPageToken, files(id, name)',
          pageSize: 200
        });
        return res.result.files || [];
      } catch (err) {
        console.error('Error listing folders', err);
        return [];
      }
    }

    function openDriveFolderSelector() {
      if (!isDriveConnected || !gapi.client || !gapi.client.getToken()) {
        showNotification('Please connect to Google Drive first', 'info');
        return;
      }

      listDriveFolders().then(folders => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-60 flex items-center justify-center p-6';
        modal.style.background = 'rgba(2,6,23,0.6)';
        modal.innerHTML = `
          <div class="w-full max-w-2xl bg-space-950 border border-white/10 rounded-xl p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg text-white font-medium">Select Drive Folder</h3>
              <button id="driveFolderClose" class="text-gray-400 hover:text-white">Close</button>
            </div>
            <div id="driveFolderList" class="max-h-64 overflow-y-auto space-y-2 text-sm"></div>
            <div class="mt-4 text-right">
              <button id="driveFolderUseRoot" class="px-3 py-2 text-sm rounded bg-white/5 hover:bg-white/10">Use My Drive (root)</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        const list = modal.querySelector('#driveFolderList');
        if (!folders || folders.length === 0) {
          list.innerHTML = `<div class="text-gray-500 text-sm">No folders found or permission required to list folders.</div>`;
        } else {
          list.innerHTML = folders.map(f => `
            <div class="p-3 rounded hover:bg-white/5 cursor-pointer flex justify-between items-center" data-id="${f.id}" data-name="${escapeHtml(f.name)}">
              <div class="text-white">${escapeHtml(f.name)}</div>
              <div class="text-gray-400 text-xs">Select</div>
            </div>
          `).join('');
          list.querySelectorAll('[data-id]').forEach(el => {
            el.addEventListener('click', () => {
              const id = el.getAttribute('data-id');
              const name = el.getAttribute('data-name');
              driveFolderId = id;
              driveFolderName = name;
              localStorage.setItem('driveFolderId', id);
              localStorage.setItem('driveFolderName', name);
              showNotification(`Folder selected: ${name}`, 'success');
              updateDriveButton();
              modal.remove();
            });
          });
        }

        modal.querySelector('#driveFolderClose').addEventListener('click', () => modal.remove());
        modal.querySelector('#driveFolderUseRoot').addEventListener('click', () => {
          driveFolderId = null;
          driveFolderName = null;
          localStorage.removeItem('driveFolderId');
          localStorage.removeItem('driveFolderName');
          showNotification('Using My Drive (root)', 'success');
          updateDriveButton();
          modal.remove();
        });
      });
    }

    // Settings modal + import/export logic
    function openSettings() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-60 flex items-center justify-center p-6';
      modal.style.background = 'rgba(2,6,23,0.6)';
      modal.id = 'settingsModal';

      modal.innerHTML = `
        <div class="w-full max-w-2xl bg-space-950 border border-white/10 rounded-xl p-6">
          <div class="flex justify-between items-start gap-4 mb-4">
            <h3 class="text-lg text-white font-medium">Settings & Backup</h3>
            <div class="flex gap-2 items-center">
              <button id="settingsClose" class="text-gray-400 hover:text-white">Close</button>
            </div>
          </div>

          <div class="space-y-4 text-sm text-gray-300">
            <section class="border-b border-white/5 pb-4">
              <h4 class="text-white font-medium mb-2">Google Drive</h4>
              <p class="text-gray-400 mb-2">Status: <span id="settingsDriveStatus">${isDriveConnected ? 'Connected' : 'Disconnected'}</span></p>
              <div class="flex gap-2 items-center">
                <button id="settingsChooseFolder" class="px-3 py-2 bg-white/5 hover:bg-white/10 rounded">Choose Folder</button>
                <div id="settingsFolderName" class="text-gray-400">${driveFolderName ? escapeHtml(driveFolderName) : 'No folder selected'}</div>
                <button id="settingsLoadDrive" class="ml-auto px-3 py-2 bg-white/5 hover:bg-white/10 rounded">Load from Drive</button>
              </div>
              <p class="text-xs text-gray-500 mt-2">Files saved to Drive will be named: <code>${DRIVE_FILE_NAME}</code></p>
            </section>

            <section class="border-b border-white/5 pb-4 pt-4">
              <h4 class="text-white font-medium mb-2">Local Import / Export</h4>
              <div class="flex gap-2 items-center">
                <input id="settingsImportInput" type="file" accept=".json,application/json" class="hidden" />
                <button id="settingsImportBtn" class="px-3 py-2 bg-white/5 hover:bg-white/10 rounded">Import .json</button>
                <button id="settingsExportBtn" class="px-3 py-2 bg-white/5 hover:bg-white/10 rounded">Export & Download .json</button>
                <button id="settingsBackupBtn" class="px-3 py-2 bg-white/5 hover:bg-white/10 rounded">Download Backup</button>
              </div>
              <p class="text-xs text-gray-500 mt-2">Importing lets you Merge or Replace current data. Always keep a backup.</p>
            </section>

            <section class="pt-4">
              <h4 class="text-white font-medium mb-2">Sync & Danger</h4>
              <div class="flex items-center gap-3">
                <label class="flex items-center gap-2"><input id="settingsAutoSave" type="checkbox" ${autoSaveToDrive ? 'checked' : ''}/> Auto-save to Drive</label>
                <button id="settingsResetBtn" class="ml-auto px-3 py-2 bg-red-600/10 hover:bg-red-600/20 rounded text-red-300">Reset Local Data</button>
              </div>
            </section>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      lucide.createIcons();

      // events
      modal.querySelector('#settingsClose').addEventListener('click', () => modal.remove());
      modal.querySelector('#settingsChooseFolder').addEventListener('click', () => {
        openDriveFolderSelector();
        setTimeout(() => {
          const nameEl = document.getElementById('settingsFolderName');
          if (nameEl) nameEl.textContent = driveFolderName || 'No folder selected';
          const status = document.getElementById('settingsDriveStatus');
          if (status) status.textContent = isDriveConnected ? 'Connected' : 'Disconnected';
        }, 400);
      });

      modal.querySelector('#settingsLoadDrive').addEventListener('click', async () => {
        if (!isDriveConnected) { showNotification('Please connect to Drive first', 'info'); return; }
        try {
          await loadFromDrive();
          showNotification('Loaded content from Drive', 'success');
        } catch (e) {
          showNotification('Failed to load from Drive', 'error');
        }
      });

      const importInput = modal.querySelector('#settingsImportInput');
      modal.querySelector('#settingsImportBtn').addEventListener('click', () => importInput.click());
      importInput.addEventListener('change', handleImportFileChange);

      modal.querySelector('#settingsExportBtn').addEventListener('click', () => {
        exportToFile(entries, false);
      });

      modal.querySelector('#settingsBackupBtn').addEventListener('click', () => {
        exportToFile(entries, true);
      });

      modal.querySelector('#settingsAutoSave').addEventListener('change', (e) => {
        autoSaveToDrive = e.target.checked;
        localStorage.setItem('autoSaveToDrive', autoSaveToDrive ? 'true' : 'false');
        showNotification('Auto-save to Drive ' + (autoSaveToDrive ? 'enabled' : 'disabled'), 'info');
      });

      modal.querySelector('#settingsResetBtn').addEventListener('click', () => {
        if (!confirm('This will clear all local entries. Are you sure?')) return;
        exportToFile(entries, true);
        entries = initialData.slice();
        saveToLocal();
        renderDashboard();
        showNotification('Local data reset. A backup was downloaded.', 'success');
        modal.remove();
      });
    }

    // Export JSON as downloadable .json file
    function exportToFile(data, backup = false) {
      try {
        const now = new Date();
        const timestamp = now.toISOString().slice(0,19).replace(/[:T]/g,'-');
        const filename = backup
          ? `galactic-archives-backup-${timestamp}.json`
          : `galactic-archives-${now.toISOString().slice(0,10)}.json`;

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        showNotification(`Downloaded ${filename}`, 'success');
      } catch (err) {
        console.error(err);
        showNotification('Failed to export file', 'error');
      }
    }

    // Import file chosen via file input and offer Merge/Replace
    async function handleImportFileChange(e) {
      const file = e.target.files && e.target.files[0];
      e.target.value = ''; // clear input
      if (!file) return;

      if (file.type && !file.type.includes('json') && !file.name.endsWith('.json')) {
        if (!confirm('Selected file does not look like JSON. Continue?')) return;
      }

      const text = await file.text().catch(() => null);
      if (!text) { showNotification('Failed to read file', 'error'); return; }

      let imported;
      try {
        imported = JSON.parse(text);
      } catch (err) {
        showNotification('Invalid JSON file', 'error');
        return;
      }

      const action = prompt('Type "merge" to append entries (avoid duplicates) or "replace" to overwrite local data. Type cancel to abort.', 'merge');
      if (!action) { showNotification('Import cancelled', 'info'); return; }

      if (action.toLowerCase() === 'replace') {
        exportToFile(entries, true);
        entries = Array.isArray(imported) ? imported : initialData.slice();
        saveToLocal();
        renderDashboard();
        showNotification('Local data replaced. Backup downloaded.', 'success');
      } else if (action.toLowerCase() === 'merge') {
        const incoming = Array.isArray(imported) ? imported : [];
        const existingIds = new Set(entries.map(e => e.id));
        const toAppend = incoming.map(item => {
          if (!item.id || existingIds.has(item.id)) {
            return { ...item, id: Date.now().toString() + '-' + Math.floor(Math.random()*10000) };
          }
          return item;
        });
        entries = entries.concat(toAppend);
        saveToLocal();
        renderDashboard();
        showNotification(`Merged ${toAppend.length} entries`, 'success');
      } else {
        showNotification('Import cancelled', 'info');
      }
    }

    // small utility to escape HTML
    function escapeHtml(str) {
      return (str || '').toString().replace(/[&<>"'`=\/]/g, s => {
        return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '/': '&#x2F;', '`': '&#x60;', '=': '&#x3D;' }[s];
      });
    }

    // Final initialization: ensure icons & content render after scripts load
    try { lucide.createIcons(); } catch (e) { console.warn('lucide not ready yet', e); }
    updateDriveButton();

    // Render home after a tiny delay to avoid micro-race issues
    setTimeout(() => {
      try { renderHome(); } catch (err) { console.error('Failed to render home on init', err); }
    }, 50);
  </script>
</body>
</html>
