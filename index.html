<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Galactic Archives - Worldbuilding Wiki</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
body { background:#000; color:#e2e8f0; }
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:#02040a}
::-webkit-scrollbar-thumb{background:#1e293b;border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:#334155}
.text-glow{text-shadow:0 0 30px rgba(59,130,246,.3)}
.btn-glow{box-shadow:0 0 20px -5px rgba(59,130,246,.5)}
.fade-enter{opacity:0;transform:translateY(10px);animation:fadein .3s forwards ease-out}
@keyframes fadein{to{opacity:1;transform:none}}
</style>
</head>

<body class="font-sans min-h-screen flex flex-col overflow-hidden">

<nav class="sticky top-0 z-50 w-full border-b border-white/5 bg-black/80 backdrop-blur-md">
  <div class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
    <div class="flex items-center gap-8">
      <button onclick="renderHome()" class="text-2xl text-white">Galactic</button>
    </div>
    <div class="flex items-center gap-4">
      <button onclick="openEditor()" class="px-4 py-2 bg-white/10 rounded-full">New Entry</button>
      <button id="driveConnectBtn" onclick="toggleDriveConnection()" class="px-4 py-2 bg-white/10 rounded-full flex gap-2 items-center">
        <i data-lucide="cloud"></i>
        <span id="driveStatusText">Connect Drive</span>
      </button>
    </div>
  </div>
</nav>

<main id="appContent" class="flex-1 overflow-y-auto p-8"></main>

<script>
/* =======================
   DATA
======================= */
const initialData = [
  {id:'1',title:'The Great Expansion',category:'Events',tags:['History'],content:'Humanity expands.',lastUpdated:'2045-10-12'}
];

let entries = JSON.parse(localStorage.getItem('wikiEntries')) || initialData;

/* =======================
   GOOGLE DRIVE CONFIG
======================= */
const GOOGLE_CLIENT_ID = '1073328285370-leiiu235gcp0ujm9s7pagi6p9quui977.apps.googleusercontent.com';
const DRIVE_FILE_NAME = 'galactic-archives-wiki.json';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

let tokenClient;
let driveFileId = localStorage.getItem('driveFileId');
let isDriveConnected = localStorage.getItem('isDriveConnected') === 'true';

/* =======================
   LOAD GOOGLE SCRIPTS
======================= */
function loadScripts() {
  const gapiScript = document.createElement('script');
  gapiScript.src = 'https://apis.google.com/js/api.js';
  gapiScript.onload = () => gapi.load('client', initGapi);
  document.head.appendChild(gapiScript);

  const gisScript = document.createElement('script');
  gisScript.src = 'https://accounts.google.com/gsi/client';
  gisScript.onload = initGis;
  document.head.appendChild(gisScript);
}

function initGapi() {
  gapi.client.init({
    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
  });
}

function initGis() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: SCOPES,
    callback: onAuth
  });
}

/* =======================
   AUTH FLOW (FIXED)
======================= */
async function onAuth(resp) {
  if (resp.error) return console.error(resp);

  // ðŸ”¥ REQUIRED LINE (THIS WAS MISSING)
  gapi.client.setToken(resp);

  isDriveConnected = true;
  localStorage.setItem('isDriveConnected','true');
  updateDriveButton();
  await loadFromDrive();
}

/* =======================
   DRIVE FUNCTIONS
======================= */
async function saveToDrive() {
  const token = gapi.client.getToken();
  if (!token) return;

  const body = JSON.stringify(entries,null,2);
  const boundary = 'foo_bar';
  const multipart =
    `--${boundary}\r\nContent-Type: application/json\r\n\r\n`+
    JSON.stringify({name:DRIVE_FILE_NAME})+
    `\r\n--${boundary}\r\nContent-Type: application/json\r\n\r\n`+
    body+`\r\n--${boundary}--`;

  const url = driveFileId
    ? `https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=multipart`
    : `https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart`;

  const res = await fetch(url,{
    method: driveFileId ? 'PATCH':'POST',
    headers:{
      Authorization:`Bearer ${token.access_token}`,
      'Content-Type':`multipart/related; boundary=${boundary}`
    },
    body:multipart
  });

  const data = await res.json();
  if (!driveFileId) {
    driveFileId = data.id;
    localStorage.setItem('driveFileId',driveFileId);
  }
}

async function loadFromDrive() {
  if (!driveFileId) return;
  const token = gapi.client.getToken();
  const res = await fetch(
    `https://www.googleapis.com/drive/v3/files/${driveFileId}?alt=media`,
    {headers:{Authorization:`Bearer ${token.access_token}`}}
  );
  entries = await res.json();
  localStorage.setItem('wikiEntries',JSON.stringify(entries));
  renderHome();
}

/* =======================
   UI
======================= */
function toggleDriveConnection() {
  if (!isDriveConnected) {
    tokenClient.requestAccessToken({prompt:'consent'});
  } else {
    google.accounts.oauth2.revoke(gapi.client.getToken().access_token);
    gapi.client.setToken('');
    isDriveConnected=false;
    localStorage.setItem('isDriveConnected','false');
    localStorage.removeItem('driveFileId');
    updateDriveButton();
  }
}

function updateDriveButton() {
  document.getElementById('driveStatusText').textContent =
    isDriveConnected ? 'Disconnect Drive':'Connect Drive';
  lucide.createIcons();
}

/* =======================
   APP
======================= */
function renderHome() {
  document.getElementById('appContent').innerHTML = `
    <h1 class="text-4xl mb-6">Entries</h1>
    ${entries.map(e=>`
      <div class="mb-4 p-4 bg-white/5 rounded">
        <h2 class="text-xl">${e.title}</h2>
        <p class="text-gray-400">${e.content}</p>
      </div>`).join('')}
  `;
}

function openEditor(){}

function saveLocal() {
  localStorage.setItem('wikiEntries',JSON.stringify(entries));
  if (isDriveConnected) saveToDrive();
}

/* =======================
   INIT
======================= */
loadScripts();
renderHome();
lucide.createIcons();
updateDriveButton();
</script>
</body>
</html>
